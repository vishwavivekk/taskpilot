# Use Node.js 22 on Debian slim for faster development
FROM node:22-slim

# Update npm to latest version
RUN npm install -g npm@latest

# Install dependencies for Prisma and other tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssl \
    ca-certificates \
    curl \
    netcat-openbsd \
    postgresql-client \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Set working directory
WORKDIR /app

# Copy application code first (needed for postinstall script)
COPY . .

# Install dependencies
RUN npm install

# Copy and set permissions for entrypoint script
COPY docker/entrypoint-dev.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Generate Prisma client
RUN npm run db:generate || true

# Expose ports
# 3000 - Backend (NestJS)
# 3001 - Frontend (Next.js)
EXPOSE 3000 3001

# Set entrypoint
ENTRYPOINT ["/entrypoint.sh"]
